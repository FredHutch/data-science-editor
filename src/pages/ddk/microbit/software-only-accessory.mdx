# micro:bit accessories with Software-Only Jacdac

The accessory sensors and actuators are surfaced as Jacdac servers by wrapping the existing extension into a Jacdac compatibility layer.
This solution adds no cost and will work for existing accessories.

-   Pros
    -   retrofit existing accessories
    -   simulation
    -   digital twin
    -   no modification to existing extensions
-   Cons
    -   no Jacdac connector
    -   micro:bit v2 only (Jacdac is not supported on v1)

## How to

For the purpose of this example, let's assume we have an extension `https://github.com/company/pxt-thing/` with blocks in the `thing` namespace.

### Step 1: preparing the new extension

We are going to create a new _nested_ extension that adds Jacdac and hides the existing blocks.

-   open https://makecode.microbit.org/
-   import your repository url with **/jacdac** appended. This will create a new extension in the same repository (if you repo is https://github.com/company/pxt-thing/, import https://github.com/company/pxt-thing/jacdac).
-   rename the project to `jacdac-thing` where `thing` is the name of your package (replace `pxt-` with `jacdac-`)
-   switch to **JavaScript**
-   expand the **Explorer** view and delete `main.blocks`
-   in the editor, add your extension github repository (`https://github.com/company/pxt-thing/`) as an extension
-   add the Jacdac extension to the project (search for `jacdac`)
-   copy the following template in `main.ts`

```typescript
//% deprecated
namespace TODO_REPLACE_THIS_WITH_BLOCK_NAMESPACE {}

namespace servers {
    function start() {
        // uncomment after device registration
        // jacdac.productIdentifier = ...

        jacdac.startSelfServers(() => [
            // instantiate servers here
        ])
    }
    start()
}

namespace modules {
    // add client fixed instances here
}
```

-   replace `TODO_REPLACE_THIS_WITH_BLOCK_NAMESPACE` with the namespace that contains your blocks to hide them

### Step 2: add sensor servers

The easiest servers a simple sensor that return a single numerical value.

Let's assume that our extension has a function `thing.lightLevel()` that returns a number `[0..1023]` from a light sensor resistor.
We want to wrap this function as a [light level](https://microsoft.github.io/jacdac-docs/services/lightlevel/) server.

-   start a `light level` simulator
-   click **Add Blocks** to import the light level constants and clients
-   update `main.ts` with the following code

```typescript
namespace servers {
    function start() {
        jacdac.startSelfServers(() => [
            jacdac.createSimpleSensorServer(
                "",
                jacdac.SRV_LIGHT_LEVEL,
                "u0.16",
                () => thing.lightLevel() / 1023
            ),
        ])
    }
    start()
}
```

Notice that we rescale the value returned by `thing.lightLevel()` to match the `[0..1]` range.

-   start a **light level** simulator in the Jacdac dashbaord
-   click on **Add Blocks** to import the `jacdac-light-level` blocks
-   update `main.ts` with a light level client

```typescript
namespace modules {
    /**
     * The thing light level sensor
     */
    //% fixedInstance whenUsed block="thing light level"
    export const thingLightLevel = new LightLevelClient(
        "thing light level?device=self"
    )
}
```

-   make sure to update the `thing light level` name in the comment, and contructor string
-   make sure to add `?device=self` to the contructor name
-   test your extension, you should be able to use the simulator and the hardware values!

> Don't forget to create a release so that your latest code changes are picked up by MakeCode!

### Step 3: Implement a custom server

If your module requires to implement another server, please reach out to the jacdac team at 
https://github.com/microsoft/jacdac/discussions.

### Step 4: Register accessory and update device identifier

To improve the user experience, register your accessory at https://microsoft.github.io/jacdac-docs/tools/device-registration/.
The user will be able to see a picture of the device and get more information from the dashboard.

-   open https://microsoft.github.io/jacdac-docs/tools/device-registration/
-   go through the registration process and copy the project identifier
-   edit `main.ts` with the project identifier

```typescript
namespace servers {
    function start() {
        jacdac.productIdentifier = 0x....
        ...
    }
    ...
}
```
